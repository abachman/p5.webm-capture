(()=>{var Pe=Object.create;var Z=Object.defineProperty;var Le=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,Ae=Object.prototype.hasOwnProperty;var We=o=>Z(o,"__esModule",{value:!0});var Ge=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var He=(o,a,T,F)=>{if(a&&typeof a=="object"||typeof a=="function")for(let v of Oe(a))!Ae.call(o,v)&&(T||v!=="default")&&Z(o,v,{get:()=>a[v],enumerable:!(F=Le(a,v))||F.enumerable});return o},ze=(o,a)=>He(We(Z(o!=null?Pe(Re(o)):{},"default",!a&&o&&o.__esModule?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);var pe=Ge((L,O)=>{(function(){"use strict";var o=!1,a=window.Tar,T=window.download,F=window.GIF,v=window.WebMWriter,I={function:!0,object:!0};function R(e){return e&&e.Object===Object?e:null}var Ne=parseFloat,Ue=parseInt,q=I[typeof L]&&L&&!L.nodeType?L:void 0,B=I[typeof O]&&O&&!O.nodeType?O:void 0,le=B&&B.exports===q?q:void 0,me=R(q&&B&&typeof global=="object"&&global),$=R(I[typeof self]&&self),N=R(I[typeof window]&&window),U=R(I[typeof this]&&this),ue=me||N!==(U&&U.window)&&N||$||U||Function("return this")();"gc"in window||(window.gc=function(){}),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,c){for(var p=atob(this.toDataURL(t,c).split(",")[1]),G=p.length,f=new Uint8Array(G),b=0;b<G;b++)f[b]=p.charCodeAt(b);e(new Blob([f],{type:t||"image/png"}))}});(function(){if("performance"in window||(window.performance={}),Date.now=Date.now||function(){return new Date().getTime()},!("now"in window.performance)){var e=Date.now();performance.timing&&performance.timing.navigationStart&&(e=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-e}}})();function M(e){return String("0000000"+e).slice(-7)}var he=window.Date.now();function de(){function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function s(e){var t={};this.settings=e,this.on=function(c,p){t[c]=p},this.emit=function(c){var p=t[c];p&&p.apply(null,Array.prototype.slice.call(arguments,1))},this.filename=e.name||de(),this.extension="",this.mimeType=""}s.prototype.start=function(){},s.prototype.stop=function(){},s.prototype.add=function(){},s.prototype.save=function(){},s.prototype.dispose=function(){},s.prototype.safeToProceed=function(){return!0},s.prototype.step=function(){console.log("Step not set!")};function d(e){s.call(this,e),this.extension=".tar",this.mimeType="application/x-tar",this.fileExtension="",this.baseFilename=this.filename,this.tape=null,this.count=0,this.part=1,this.frames=0}d.prototype=Object.create(s.prototype),d.prototype.start=function(){this.dispose()},d.prototype.add=function(e){var t=new FileReader;t.onload=function(){this.tape.append(M(this.count)+this.fileExtension,new Uint8Array(t.result)),this.settings.autoSaveTime>0&&this.frames/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(c){this.filename=this.baseFilename+"-part-"+M(this.part),T(c,this.filename+this.extension,this.mimeType);var p=this.count;this.dispose(),this.count=p+1,this.part++,this.filename=this.baseFilename+"-part-"+M(this.part),this.frames=0,this.step()}.bind(this)):(this.count++,this.frames++,this.step())}.bind(this),t.readAsArrayBuffer(e)},d.prototype.save=function(e){e(this.tape.save())},d.prototype.dispose=function(){this.tape=new a,this.count=0};function j(e){d.call(this,e),this.type="image/png",this.fileExtension=".png"}j.prototype=Object.create(d.prototype),j.prototype.add=function(e){e.toBlob(function(t){d.prototype.add.call(this,t)}.bind(this),this.type)};function V(e){d.call(this,e),this.type="image/jpeg",this.fileExtension=".jpg",this.quality=e.quality/100||.8}V.prototype=Object.create(d.prototype),V.prototype.add=function(e){e.toBlob(function(t){d.prototype.add.call(this,t)}.bind(this),this.type,this.quality)};function _(e){var t=document.createElement("canvas");t.toDataURL("image/webp").substr(5,10)!=="image/webp"&&console.log("WebP not supported - try another export format"),s.call(this,e),this.quality=e.quality/100||.8,this.extension=".webm",this.mimeType="video/webm",this.baseFilename=this.filename,this.framerate=e.framerate,this.frames=0,this.part=1,this.videoWriter=new v({quality:this.quality,fileWriter:null,fd:null,frameRate:this.framerate})}_.prototype=Object.create(s.prototype),_.prototype.start=function(e){this.dispose()},_.prototype.add=function(e){this.videoWriter.addFrame(e),this.settings.autoSaveTime>0&&this.frames/this.settings.framerate>=this.settings.autoSaveTime?this.save(function(t){this.filename=this.baseFilename+"-part-"+M(this.part),T(t,this.filename+this.extension,this.mimeType),this.dispose(),this.part++,this.filename=this.baseFilename+"-part-"+M(this.part),this.step()}.bind(this)):(this.frames++,this.step())},_.prototype.save=function(e){this.videoWriter.complete().then(e)},_.prototype.dispose=function(e){this.frames=0,this.videoWriter=new v({quality:this.quality,fileWriter:null,fd:null,frameRate:this.framerate})};function S(e){s.call(this,e),e.quality=e.quality/100||.8,this.encoder=new FFMpegServer.Video(e),this.encoder.on("process",function(){this.emit("process")}.bind(this)),this.encoder.on("finished",function(t,c){var p=this.callback;p&&(this.callback=void 0,p(t,c))}.bind(this)),this.encoder.on("progress",function(t){this.settings.onProgress&&this.settings.onProgress(t)}.bind(this)),this.encoder.on("error",function(t){alert(JSON.stringify(t,null,2))}.bind(this))}S.prototype=Object.create(s.prototype),S.prototype.start=function(){this.encoder.start(this.settings)},S.prototype.add=function(e){this.encoder.add(e)},S.prototype.save=function(e){this.callback=e,this.encoder.end()},S.prototype.safeToProceed=function(){return this.encoder.safeToProceed()};function A(e){s.call(this,e),this.framerate=this.settings.framerate,this.type="video/webm",this.extension=".webm",this.stream=null,this.mediaRecorder=null,this.chunks=[]}A.prototype=Object.create(s.prototype),A.prototype.add=function(e){this.stream||(this.stream=e.captureStream(this.framerate),this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.start(),this.mediaRecorder.ondataavailable=function(t){this.chunks.push(t.data)}.bind(this)),this.step()},A.prototype.save=function(e){this.mediaRecorder.onstop=function(t){var c=new Blob(this.chunks,{type:"video/webm"});this.chunks=[],e(c)}.bind(this),this.mediaRecorder.stop()};function W(e){s.call(this,e),e.quality=31-(e.quality*30/100||10),e.workers=e.workers||4,this.extension=".gif",this.mimeType="image/gif",this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.sizeSet=!1,this.encoder=new F({workers:e.workers,quality:e.quality,workerScript:e.workersPath+"gif.worker.js"}),this.encoder.on("progress",function(t){this.settings.onProgress&&this.settings.onProgress(t)}.bind(this)),this.encoder.on("finished",function(t){var c=this.callback;c&&(this.callback=void 0,c(t))}.bind(this))}W.prototype=Object.create(s.prototype),W.prototype.add=function(e){this.sizeSet||(this.encoder.setOption("width",e.width),this.encoder.setOption("height",e.height),this.sizeSet=!0),this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.drawImage(e,0,0),this.encoder.addFrame(this.ctx,{copy:!0,delay:this.settings.step}),this.step()},W.prototype.save=function(e){this.callback=e,this.encoder.render()};function x(e){var t=e||{},c=new Date,p,G,f,b,J,K,Y,m,C=[],k=[],g=0,E=0,je=null,Q=[],X=!1,ee={};t.framerate=t.framerate||60,t.motionBlurFrames=2*(t.motionBlurFrames||1),p=t.verbose||!1,G=t.display||!1,t.step=1e3/t.framerate,t.timeLimit=t.timeLimit||0,t.frameLimit=t.frameLimit||0,t.startTime=t.startTime||0;var u=document.createElement("div");u.style.position="absolute",u.style.left=u.style.top=0,u.style.backgroundColor="black",u.style.fontFamily="monospace",u.style.fontSize="11px",u.style.padding="5px",u.style.color="red",u.style.zIndex=1e5,t.display&&document.body.appendChild(u);var h=document.createElement("canvas"),P=h.getContext("2d"),l,D;w("Step is set to "+t.step+"ms");var te={gif:W,webm:_,ffmpegserver:S,png:j,jpg:V,"webm-mediarecorder":A},ie=te[t.format];if(!ie)throw"Error: Incorrect or missing format: Valid formats are "+Object.keys(te).join(", ");if(m=new ie(t),m.step=Y,m.on("process",se),m.on("progress",Me),"performance"in window||(window.performance={}),Date.now=Date.now||function(){return new Date().getTime()},!("now"in window.performance)){var re=Date.now();performance.timing&&performance.timing.navigationStart&&(re=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-re}}var ne=window.setTimeout,we=window.setInterval,ye=window.clearInterval,ge=window.clearTimeout,ve=window.requestAnimationFrame,be=window.Date.now,Ce=window.performance.now,Te=window.Date.prototype.getTime,oe=[];function Fe(){w("Capturer start"),b=window.Date.now(),f=b+t.startTime,K=window.performance.now(),J=K+t.startTime,window.Date.prototype.getTime=function(){return f},window.Date.now=function(){return f},window.setTimeout=function(i,n){var y={callback:i,time:n,triggerTime:f+n};return C.push(y),w("Timeout set to "+y.time),y},window.clearTimeout=function(i){for(var n=0;n<C.length;n++)if(C[n]==i){C.splice(n,1),w("Timeout cleared");continue}},window.setInterval=function(i,n){var y={callback:i,time:n,triggerTime:f+n};return k.push(y),w("Interval set to "+y.time),y},window.clearInterval=function(i){return w("clear Interval"),null},window.requestAnimationFrame=function(i){Q.push(i)},window.performance.now=function(){return J};function r(){return this._hooked||(this._hooked=!0,this._hookedTime=this.currentTime||0,this.pause(),oe.push(this)),this._hookedTime+t.startTime}try{Object.defineProperty(HTMLVideoElement.prototype,"currentTime",{get:r}),Object.defineProperty(HTMLAudioElement.prototype,"currentTime",{get:r})}catch(i){w(i)}}function _e(){Fe(),m.start(),X=!0}function ae(){X=!1,m.stop(),Se()}function H(r,i){ne(r,0,i)}function Y(){H(se)}function Se(){w("Capturer stop"),window.setTimeout=ne,window.setInterval=we,window.clearInterval=ye,window.clearTimeout=ge,window.requestAnimationFrame=ve,window.Date.prototype.getTime=Te,window.Date.now=be,window.performance.now=Ce}function xe(){var r=g/t.framerate;(t.frameLimit&&g>=t.frameLimit||t.timeLimit&&r>=t.timeLimit)&&(ae(),ce());var i=new Date(null);i.setSeconds(r),t.motionBlurFrames>2?u.textContent="CCapture "+t.format+" | "+g+" frames ("+E+" inter) | "+i.toISOString().substr(11,8):u.textContent="CCapture "+t.format+" | "+g+" frames | "+i.toISOString().substr(11,8)}function ke(r){(h.width!==r.width||h.height!==r.height)&&(h.width=r.width,h.height=r.height,l=new Uint16Array(h.height*h.width*4),P.fillStyle="#0",P.fillRect(0,0,h.width,h.height))}function Ee(r){P.drawImage(r,0,0),D=P.getImageData(0,0,h.width,h.height);for(var i=0;i<l.length;i+=4)l[i]+=D.data[i],l[i+1]+=D.data[i+1],l[i+2]+=D.data[i+2];E++}function De(){for(var r=D.data,i=0;i<l.length;i+=4)r[i]=l[i]*2/t.motionBlurFrames,r[i+1]=l[i+1]*2/t.motionBlurFrames,r[i+2]=l[i+2]*2/t.motionBlurFrames;P.putImageData(D,0,0),m.add(h),g++,E=0,w("Full MB Frame! "+g+" "+f);for(var i=0;i<l.length;i+=4)l[i]=0,l[i+1]=0,l[i+2]=0;gc()}function Ie(r){X&&(t.motionBlurFrames>2?(ke(r),Ee(r),E>=.5*t.motionBlurFrames?De():Y()):(m.add(r),g++,w("Full Frame! "+g)))}function se(){var r=1e3/t.framerate,i=(g+E/t.motionBlurFrames)*r;f=b+i,J=K+i,oe.forEach(function(y){y._hookedTime=i/1e3}),xe(),w("Frame: "+g+" "+E);for(var n=0;n<C.length;n++)if(f>=C[n].triggerTime){H(C[n].callback),C.splice(n,1);continue}for(var n=0;n<k.length;n++)if(f>=k[n].triggerTime){H(k[n].callback),k[n].triggerTime+=k[n].time;continue}Q.forEach(function(y){H(y,f-he)}),Q=[]}function ce(r){r||(r=function(i){return T(i,m.filename+m.extension,m.mimeType),!1}),m.save(r)}function w(r){p&&console.log(r)}function qe(r,i){ee[r]=i}function Be(r){var i=ee[r];i&&i.apply(null,Array.prototype.slice.call(arguments,1))}function Me(r){Be("progress",r)}return{start:_e,capture:Ie,stop:ae,save:ce,on:qe}}(N||$||{}).CCapture=x,typeof define=="function"&&typeof define.amd=="object"&&define.amd?define(function(){return x}):q&&B?(le&&((B.exports=x).CCapture=x),q.CCapture=x):ue.CCapture=x})()});var fe=ze(pe()),z=class{constructor(){this.active=!1,this.running=!1}enableCapture({frameCount:a,element:T,onComplete:F}){this.active=!0,this.el=T,this.maxFrames=a,this.frames=0,this.capture=new fe.default({framerate:60,format:"webm",verbose:!1}),this.onComplete=F||function(){}}captureFrame(){this.active&&!this.running&&this.capture.start(),this.active&&(this.capture.capture(this.el),this.frames++,this.frames>this.maxFrames&&(this.capture.stop(),this.capture.save(),this.onComplete()))}};if(window){let o=new z;window.enableCapture=o.enableCapture,window.captureFrame=o.captureFrame}})();
// @license http://opensource.org/licenses/MIT
//# sourceMappingURL=p5.webm-capture.js.map
